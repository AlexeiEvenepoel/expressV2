<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestor de Programaciones - Sistema de Tickets</title>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        text-align: center;
        color: white;
        margin-bottom: 30px;
      }

      .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .header p {
        font-size: 1.1rem;
        opacity: 0.9;
      }

      .dashboard {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
      }

      .card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        transition:
          transform 0.3s ease,
          box-shadow 0.3s ease;
      }

      .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
      }

      .card h2 {
        color: #4a5568;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .calendar-container {
        grid-column: 1 / -1;
      }

      .calendar {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 2px;
        margin-top: 20px;
      }

      .calendar-header {
        background: #667eea;
        color: white;
        padding: 15px;
        text-align: center;
        font-weight: bold;
        border-radius: 8px;
      }

      .calendar-day {
        background: #f7fafc;
        border: 2px solid #e2e8f0;
        padding: 15px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        border-radius: 8px;
        min-height: 80px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
      }

      .calendar-day:hover {
        background: #e6fffa;
        border-color: #38b2ac;
      }

      .calendar-day.selected {
        background: #667eea;
        color: white;
        border-color: #5a67d8;
      }

      .calendar-day.has-schedule {
        background: #c6f6d5;
        border-color: #38a169;
      }

      .calendar-day.has-schedule.selected {
        background: #38a169;
      }

      .day-number {
        font-weight: bold;
        font-size: 1.1rem;
      }

      .schedule-indicator {
        font-size: 0.8rem;
        color: #38a169;
        margin-top: 5px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #4a5568;
      }

      .form-control {
        width: 100%;
        padding: 12px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.3s ease;
      }

      .form-control:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
        text-align: center;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .btn-success {
        background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        color: white;
      }

      .btn-danger {
        background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
        color: white;
      }

      .btn-warning {
        background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
        color: white;
      }

      .btn-group {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .schedule-list {
        max-height: 400px;
        overflow-y: auto;
      }

      .schedule-item {
        background: #f7fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.3s ease;
      }

      .schedule-item:hover {
        background: #edf2f7;
        border-color: #cbd5e0;
      }

      .schedule-item.active {
        border-color: #48bb78;
        background: #f0fff4;
      }

      .schedule-item.inactive {
        opacity: 0.6;
        background: #fed7d7;
        border-color: #fc8181;
      }

      .schedule-info h4 {
        color: #2d3748;
        margin-bottom: 5px;
      }

      .schedule-info p {
        color: #718096;
        font-size: 0.9rem;
      }

      .schedule-actions {
        display: flex;
        gap: 8px;
      }

      .btn-sm {
        padding: 6px 12px;
        font-size: 0.8rem;
      }

      .status-indicator {
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 600;
        text-align: center;
        margin-bottom: 15px;
      }

      .status-connected {
        background: #c6f6d5;
        color: #22543d;
      }

      .status-disconnected {
        background: #fed7d7;
        color: #742a2a;
      }

      .checkbox-group {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-top: 10px;
      }

      .checkbox-item {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .checkbox-item input[type='checkbox'] {
        width: 18px;
        height: 18px;
        accent-color: #667eea;
      }

      .log-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 50%;
        color: white;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        z-index: 1000;
        transition: all 0.3s ease;
        font-size: 1.5rem;
      }

      .log-container:hover {
        transform: scale(1.1);
      }

      .log-container.expanded {
        width: 500px;
        height: 400px;
        border-radius: 15px;
        background: white;
        overflow: hidden;
        font-size: 1rem;
      }

      .log-header {
        display: none;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        justify-content: space-between;
        align-items: center;
      }

      .log-container.expanded .log-header {
        display: flex;
      }

      #log {
        display: none;
        height: 340px;
        overflow-y: auto;
        padding: 15px;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        background: #f8f9fa;
      }

      .log-container.expanded #log {
        display: block;
      }

      .log-entry {
        margin-bottom: 8px;
        padding: 8px;
        border-radius: 4px;
      }

      .log-entry.success {
        background: #d4edda;
        color: #155724;
      }

      .log-entry.error {
        background: #f8d7da;
        color: #721c24;
      }

      .log-entry.info {
        background: #d1ecf1;
        color: #0c5460;
      }

      .close-btn {
        background: none;
        border: none;
        color: white;
        font-size: 1.2rem;
        cursor: pointer;
        padding: 5px;
      }

      @media (max-width: 768px) {
        .dashboard {
          grid-template-columns: 1fr;
        }

        .calendar {
          font-size: 0.9rem;
        }

        .calendar-day {
          min-height: 60px;
          padding: 10px;
        }

        .btn-group {
          flex-direction: column;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üóìÔ∏è Gestor de Programaciones</h1>
        <p>Sistema inteligente de programaci√≥n autom√°tica de tickets</p>
      </div>

      <div class="dashboard">
        <!-- Conexi√≥n WebSocket -->
        <div class="card">
          <h2>üîå Conexi√≥n en Tiempo Real</h2>
          <div
            id="connectionStatus"
            class="status-indicator status-disconnected"
          >
            Desconectado
          </div>
          <div class="btn-group">
            <button id="connectBtn" class="btn btn-primary">Conectar</button>
            <button id="disconnectBtn" class="btn btn-danger">
              Desconectar
            </button>
          </div>
        </div>

        <!-- Usuarios -->
        <div class="card">
          <h2>üë• Gesti√≥n de Usuarios</h2>
          <div class="form-group">
            <label for="userSelect">Seleccionar Usuario:</label>
            <select id="userSelect" class="form-control">
              <option value="">Cargando usuarios...</option>
            </select>
          </div>
          <div class="btn-group">
            <button onclick="loadUsers()" class="btn btn-primary">
              Recargar
            </button>
            <button onclick="createUser()" class="btn btn-success">
              Nuevo Usuario
            </button>
          </div>
        </div>

        <!-- Calendario -->
        <div class="card calendar-container">
          <h2>üìÖ Calendario de Programaciones</h2>
          <div class="btn-group">
            <button onclick="previousMonth()" class="btn btn-primary">
              ‚Üê Mes Anterior
            </button>
            <span
              id="currentMonth"
              style="font-weight: bold; padding: 12px"
            ></span>
            <button onclick="nextMonth()" class="btn btn-primary">
              Mes Siguiente ‚Üí
            </button>
          </div>
          <div class="calendar" id="calendar"></div>
        </div>

        <!-- Crear Programaci√≥n -->
        <div class="card">
          <h2>‚ûï Nueva Programaci√≥n</h2>
          <form id="scheduleForm">
            <div class="form-group">
              <label for="scheduleDate">Fecha:</label>
              <input
                type="date"
                id="scheduleDate"
                class="form-control"
                required
              />
            </div>

            <div class="form-group">
              <label>Hora (HH:MM:SS):</label>
              <div
                style="
                  display: flex;
                  gap: 8px;
                  align-items: center;
                  flex-wrap: wrap;
                "
              >
                <div style="display: flex; gap: 5px; align-items: center">
                  <input
                    type="number"
                    id="scheduleHour"
                    class="form-control"
                    min="0"
                    max="23"
                    value="10"
                    style="width: 70px"
                    placeholder="HH"
                    title="Horas (0-23)"
                  />
                  <span style="font-weight: bold">:</span>
                  <input
                    type="number"
                    id="scheduleMinute"
                    class="form-control"
                    min="0"
                    max="59"
                    value="00"
                    style="width: 70px"
                    placeholder="MM"
                    title="Minutos (0-59)"
                  />
                  <span style="font-weight: bold">:</span>
                  <input
                    type="number"
                    id="scheduleSecond"
                    class="form-control"
                    min="0"
                    max="59"
                    value="00"
                    style="width: 70px"
                    placeholder="SS"
                    title="Segundos (0-59)"
                  />
                </div>
                <button
                  type="button"
                  onclick="setCurrentTime()"
                  class="btn btn-sm"
                  style="
                    background: #e2e8f0;
                    padding: 8px 12px;
                    font-size: 0.8rem;
                  "
                >
                  ‚è∞ Ahora
                </button>
                <button
                  type="button"
                  onclick="setCommonTime('10:00:00')"
                  class="btn btn-sm"
                  style="
                    background: #c6f6d5;
                    padding: 8px 12px;
                    font-size: 0.8rem;
                  "
                >
                  üçΩÔ∏è 10:00 AM
                </button>
              </div>
              <small
                style="
                  color: #666;
                  font-size: 0.8rem;
                  display: block;
                  margin-top: 5px;
                "
              >
                üí° Tip: Use segundos espec√≠ficos para evitar conflictos (ej:
                10:00:15)
              </small>
            </div>

            <div class="form-group">
              <label for="scheduleDescription">Descripci√≥n:</label>
              <input
                type="text"
                id="scheduleDescription"
                class="form-control"
                placeholder="Ej: Registro diario de comedor"
              />
            </div>

            <div class="form-group">
              <label>
                <input type="checkbox" id="isRecurring" /> Programaci√≥n
                recurrente
              </label>
            </div>

            <div id="recurringDays" style="display: none">
              <label>D√≠as de la semana:</label>
              <div class="checkbox-group">
                <div class="checkbox-item">
                  <input type="checkbox" id="monday" value="monday" />
                  <label for="monday">Lunes</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="tuesday" value="tuesday" />
                  <label for="tuesday">Martes</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="wednesday" value="wednesday" />
                  <label for="wednesday">Mi√©rcoles</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="thursday" value="thursday" />
                  <label for="thursday">Jueves</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="friday" value="friday" />
                  <label for="friday">Viernes</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="saturday" value="saturday" />
                  <label for="saturday">S√°bado</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="sunday" value="sunday" />
                  <label for="sunday">Domingo</label>
                </div>
              </div>
            </div>

            <div class="btn-group">
              <button type="submit" class="btn btn-success">
                Crear Programaci√≥n
              </button>
              <button
                type="button"
                onclick="clearForm()"
                class="btn btn-warning"
              >
                Limpiar
              </button>
            </div>
          </form>
        </div>

        <!-- Lista de Programaciones -->
        <div class="card">
          <h2>üìã Programaciones Activas</h2>
          <div class="btn-group">
            <button onclick="loadSchedules()" class="btn btn-primary">
              Actualizar
            </button>
            <button onclick="loadUpcoming()" class="btn btn-success">
              Pr√≥ximas
            </button>
            <button
              onclick="debugJobs()"
              class="btn"
              style="background: #ffd700; color: #333"
            >
              üîç Debug Jobs
            </button>
          </div>
          <div id="schedulesList" class="schedule-list">
            <p>Cargando programaciones...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Log flotante -->
    <div class="log-container" id="logContainer">
      <div id="logBubble">üìã</div>
      <div class="log-header">
        <h3>Log de Eventos</h3>
        <button class="close-btn" id="closeLog">‚úñ</button>
      </div>
      <div id="log"></div>
    </div>

    <script>
      let socket = null;
      let currentDate = new Date();
      let selectedDate = null;
      let schedules = [];
      const API_BASE = 'http://localhost:3000';

      // Inicializaci√≥n
      window.onload = function () {
        log('üöÄ Gestor de programaciones iniciado');
        loadUsers();
        renderCalendar();
        loadSchedules();

        // Auto-conectar WebSocket
        setTimeout(() => {
          document.getElementById('connectBtn').click();
        }, 1000);
      };

      // Gesti√≥n del log flotante
      const logContainer = document.getElementById('logContainer');
      const closeLogBtn = document.getElementById('closeLog');

      logContainer.addEventListener('click', function (e) {
        if (e.target !== closeLogBtn) {
          this.classList.toggle('expanded');
        }
      });

      closeLogBtn.addEventListener('click', function (e) {
        e.stopPropagation();
        logContainer.classList.remove('expanded');
      });

      function log(message, type = 'info') {
        const logDiv = document.getElementById('log');
        const timestamp = new Date().toLocaleTimeString();
        const entry = document.createElement('div');
        entry.className = `log-entry ${type}`;
        entry.innerHTML = `[${timestamp}] ${message}`;
        logDiv.appendChild(entry);
        logDiv.scrollTop = logDiv.scrollHeight;
      }

      // WebSocket
      document.getElementById('connectBtn').onclick = function () {
        if (socket) return;

        socket = io(API_BASE);

        socket.on('connect', () => {
          log('‚úÖ Conectado al WebSocket', 'success');
          document.getElementById('connectionStatus').innerHTML = 'Conectado';
          document.getElementById('connectionStatus').className =
            'status-indicator status-connected';
        });

        socket.on('disconnect', () => {
          log('‚ùå Desconectado del WebSocket', 'error');
          document.getElementById('connectionStatus').innerHTML =
            'Desconectado';
          document.getElementById('connectionStatus').className =
            'status-indicator status-disconnected';
        });

        socket.on('scheduleExecuted', (data) => {
          log(
            `üìÖ Programaci√≥n ejecutada: ${data.message}`,
            data.success ? 'success' : 'error',
          );
          loadSchedules(); // Actualizar lista
        });
      };

      document.getElementById('disconnectBtn').onclick = function () {
        if (socket) {
          socket.disconnect();
          socket = null;
        }
      };

      // Gesti√≥n de usuarios
      async function loadUsers() {
        try {
          const response = await fetch(`${API_BASE}/users`);
          const users = await response.json();

          const select = document.getElementById('userSelect');
          select.innerHTML = '<option value="">Seleccionar usuario...</option>';

          users.forEach((user) => {
            const option = document.createElement('option');
            option.value = user.id;
            option.textContent = `${user.name} (${user.dni})`;
            select.appendChild(option);
          });

          log(`üë• Cargados ${users.length} usuarios`, 'success');
        } catch (error) {
          log(`‚ùå Error cargando usuarios: ${error.message}`, 'error');
        }
      }

      function createUser() {
        const name = prompt('Nombre del usuario:');
        const dni = prompt('DNI:');
        const code = prompt('C√≥digo:');

        if (name && dni && code) {
          fetch(`${API_BASE}/users`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, dni, code }),
          })
            .then((response) => response.json())
            .then((user) => {
              log(`‚úÖ Usuario creado: ${user.name}`, 'success');
              loadUsers();
            })
            .catch((error) => {
              log(`‚ùå Error creando usuario: ${error.message}`, 'error');
            });
        }
      }

      // Calendario
      function renderCalendar() {
        const calendar = document.getElementById('calendar');
        const monthNames = [
          'Enero',
          'Febrero',
          'Marzo',
          'Abril',
          'Mayo',
          'Junio',
          'Julio',
          'Agosto',
          'Septiembre',
          'Octubre',
          'Noviembre',
          'Diciembre',
        ];

        document.getElementById('currentMonth').textContent =
          `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;

        calendar.innerHTML = '';

        // Headers
        const dayHeaders = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
        dayHeaders.forEach((day) => {
          const header = document.createElement('div');
          header.className = 'calendar-header';
          header.textContent = day;
          calendar.appendChild(header);
        });

        // Days
        const firstDay = new Date(
          currentDate.getFullYear(),
          currentDate.getMonth(),
          1,
        );
        const lastDay = new Date(
          currentDate.getFullYear(),
          currentDate.getMonth() + 1,
          0,
        );
        const startDate = new Date(firstDay);
        startDate.setDate(startDate.getDate() - firstDay.getDay());

        for (let i = 0; i < 42; i++) {
          const date = new Date(startDate);
          date.setDate(startDate.getDate() + i);

          const dayElement = document.createElement('div');
          dayElement.className = 'calendar-day';

          if (date.getMonth() !== currentDate.getMonth()) {
            dayElement.style.opacity = '0.3';
          }

          // Check if this date has schedules
          const dateStr = date.toISOString().split('T')[0];
          const hasSchedule = schedules.some(
            (s) => s.scheduledDate.startsWith(dateStr) || s.isRecurring,
          );

          if (hasSchedule) {
            dayElement.classList.add('has-schedule');
          }

          dayElement.innerHTML = `
            <div class="day-number">${date.getDate()}</div>
            ${hasSchedule ? '<div class="schedule-indicator">üìÖ</div>' : ''}
          `;

          dayElement.onclick = () => selectDate(date);
          calendar.appendChild(dayElement);
        }
      }

      function selectDate(date) {
        selectedDate = date;
        document.getElementById('scheduleDate').value = date
          .toISOString()
          .split('T')[0];

        // Update visual selection
        document.querySelectorAll('.calendar-day').forEach((day) => {
          day.classList.remove('selected');
        });
        event.target.closest('.calendar-day').classList.add('selected');

        log(`üìÖ Fecha seleccionada: ${date.toLocaleDateString()}`, 'info');
      }

      function previousMonth() {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
      }

      function nextMonth() {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
      }

      // Programaciones
      document.getElementById('isRecurring').onchange = function () {
        const recurringDiv = document.getElementById('recurringDays');
        recurringDiv.style.display = this.checked ? 'block' : 'none';
      };

      document.getElementById('scheduleForm').onsubmit = async function (e) {
        e.preventDefault();

        const userId = document.getElementById('userSelect').value;
        if (!userId) {
          alert('Por favor selecciona un usuario');
          return;
        }

        // Get time components
        const hour = document
          .getElementById('scheduleHour')
          .value.padStart(2, '0');
        const minute = document
          .getElementById('scheduleMinute')
          .value.padStart(2, '0');
        const second = document
          .getElementById('scheduleSecond')
          .value.padStart(2, '0');
        const formattedTime = `${hour}:${minute}:${second}`;

        const formData = {
          userId: parseInt(userId),
          scheduledDate: document.getElementById('scheduleDate').value,
          scheduledTime: formattedTime,
          description: document.getElementById('scheduleDescription').value,
          isRecurring: document.getElementById('isRecurring').checked,
        };

        if (formData.isRecurring) {
          const days = [];
          [
            'monday',
            'tuesday',
            'wednesday',
            'thursday',
            'friday',
            'saturday',
            'sunday',
          ].forEach((day) => {
            if (document.getElementById(day).checked) {
              days.push(day);
            }
          });
          formData.recurringDays = days;
        }

        // Validate time format before sending
        const timePattern = /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]$/;
        if (!timePattern.test(formData.scheduledTime)) {
          log(
            `‚ùå Formato de hora inv√°lido. Use HH:MM:SS (ej: 10:00:00)`,
            'error',
          );
          return;
        }

        // Validate date
        const scheduleDate = new Date(formData.scheduledDate);
        if (isNaN(scheduleDate.getTime())) {
          log(`‚ùå Fecha inv√°lida`, 'error');
          return;
        }

        log(
          `üì§ Enviando programaci√≥n: ${JSON.stringify(formData, null, 2)}`,
          'info',
        );

        try {
          const response = await fetch(`${API_BASE}/schedules`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData),
          });

          const result = await response.json();

          if (response.ok) {
            log(
              `‚úÖ Programaci√≥n creada exitosamente (ID: ${result.id})`,
              'success',
            );
            log(
              `üìÖ Pr√≥xima ejecuci√≥n programada para: ${result.scheduledDate} ${result.scheduledTime}`,
              'info',
            );
            clearForm();
            loadSchedules();
            renderCalendar();
          } else {
            log(
              `‚ùå Error del servidor: ${result.message || JSON.stringify(result)}`,
              'error',
            );
            if (result.error && Array.isArray(result.message)) {
              result.message.forEach((msg) => log(`   - ${msg}`, 'error'));
            }
          }
        } catch (error) {
          log(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
        }
      };

      function clearForm() {
        document.getElementById('scheduleForm').reset();
        document.getElementById('scheduleHour').value = '10';
        document.getElementById('scheduleMinute').value = '00';
        document.getElementById('scheduleSecond').value = '00';
        document.getElementById('recurringDays').style.display = 'none';
      }

      async function loadSchedules() {
        try {
          const response = await fetch(`${API_BASE}/schedules`);
          schedules = await response.json();
          renderSchedulesList();
          renderCalendar(); // Update calendar with schedule indicators
          log(`üìã Cargadas ${schedules.length} programaciones`, 'success');
        } catch (error) {
          log(`‚ùå Error cargando programaciones: ${error.message}`, 'error');
        }
      }

      async function loadUpcoming() {
        try {
          const response = await fetch(`${API_BASE}/schedules/upcoming`);
          const upcoming = await response.json();
          schedules = upcoming;
          renderSchedulesList();
          log(
            `üìã Cargadas ${upcoming.length} programaciones pr√≥ximas`,
            'success',
          );
        } catch (error) {
          log(
            `‚ùå Error cargando pr√≥ximas programaciones: ${error.message}`,
            'error',
          );
        }
      }

      function renderSchedulesList() {
        const container = document.getElementById('schedulesList');

        if (schedules.length === 0) {
          container.innerHTML = '<p>No hay programaciones</p>';
          return;
        }

        container.innerHTML = schedules
          .map(
            (schedule) => `
          <div class="schedule-item ${schedule.isActive ? 'active' : 'inactive'}">
            <div class="schedule-info">
              <h4>${schedule.user.name}</h4>
              <p>üìÖ ${new Date(schedule.scheduledDate).toLocaleDateString()} a las ${schedule.scheduledTime}</p>
              <p>${schedule.description || 'Sin descripci√≥n'}</p>
              ${schedule.isRecurring ? '<p>üîÑ Recurrente: ' + JSON.parse(schedule.recurringDays || '[]').join(', ') + '</p>' : ''}
            </div>
            <div class="schedule-actions">
              <button onclick="testSchedule(${schedule.id})" class="btn btn-sm" style="background: #ffd700; color: #333;">
                üß™ Test
              </button>
              <button onclick="toggleSchedule(${schedule.id})" class="btn btn-sm ${schedule.isActive ? 'btn-warning' : 'btn-success'}">
                ${schedule.isActive ? 'Pausar' : 'Activar'}
              </button>
              <button onclick="deleteSchedule(${schedule.id})" class="btn btn-sm btn-danger">
                Eliminar
              </button>
            </div>
          </div>
        `,
          )
          .join('');
      }

      async function toggleSchedule(id) {
        try {
          const response = await fetch(`${API_BASE}/schedules/${id}/toggle`, {
            method: 'PATCH',
          });

          if (response.ok) {
            log(`‚úÖ Programaci√≥n actualizada`, 'success');
            loadSchedules();
          }
        } catch (error) {
          log(`‚ùå Error actualizando programaci√≥n: ${error.message}`, 'error');
        }
      }

      async function deleteSchedule(id) {
        if (confirm('¬øEst√°s seguro de eliminar esta programaci√≥n?')) {
          try {
            const response = await fetch(`${API_BASE}/schedules/${id}`, {
              method: 'DELETE',
            });

            if (response.ok) {
              log(`‚úÖ Programaci√≥n eliminada`, 'success');
              loadSchedules();
              renderCalendar();
            }
          } catch (error) {
            log(`‚ùå Error eliminando programaci√≥n: ${error.message}`, 'error');
          }
        }
      }

      // Funciones de debug
      async function debugJobs() {
        try {
          const response = await fetch(`${API_BASE}/schedules/debug/jobs`);
          const result = await response.json();

          log(`üîç Jobs activos: ${result.totalJobs}`, 'info');
          result.jobs.forEach((job) => {
            log(
              `   üìã Schedule ${job.scheduleId}: Running=${job.running}, Next: ${job.nextExecutions?.[0] || 'N/A'}`,
              'info',
            );
          });

          console.log('Debug Jobs Result:', result);
        } catch (error) {
          log(`‚ùå Error obteniendo debug info: ${error.message}`, 'error');
        }
      }

      async function testSchedule(scheduleId) {
        try {
          log(`üß™ Probando ejecuci√≥n de programaci√≥n ${scheduleId}...`, 'info');
          const response = await fetch(
            `${API_BASE}/schedules/debug/test/${scheduleId}`,
            {
              method: 'POST',
            },
          );
          const result = await response.json();

          if (response.ok) {
            log(
              `‚úÖ Test completado: ${result.successfulAttempts}/${result.totalAttempts} exitosos para ${result.userName}`,
              'success',
            );
          } else {
            log(`‚ùå Test fall√≥: ${result.message}`, 'error');
          }
        } catch (error) {
          log(`‚ùå Error en test: ${error.message}`, 'error');
        }
      }

      // Funciones auxiliares para manejo de tiempo
      function setCurrentTime() {
        const now = new Date();
        document.getElementById('scheduleHour').value = now
          .getHours()
          .toString()
          .padStart(2, '0');
        document.getElementById('scheduleMinute').value = now
          .getMinutes()
          .toString()
          .padStart(2, '0');
        document.getElementById('scheduleSecond').value = now
          .getSeconds()
          .toString()
          .padStart(2, '0');
        log(`‚è∞ Hora establecida a: ${now.toLocaleTimeString()}`, 'info');
      }

      function setCommonTime(timeStr) {
        const [hour, minute, second] = timeStr.split(':');
        document.getElementById('scheduleHour').value = hour;
        document.getElementById('scheduleMinute').value = minute;
        document.getElementById('scheduleSecond').value = second || '00';
        log(`üïê Hora establecida a: ${timeStr}`, 'info');
      }

      // Validaci√≥n en tiempo real de los campos de tiempo
      document.addEventListener('DOMContentLoaded', function () {
        const hourInput = document.getElementById('scheduleHour');
        const minuteInput = document.getElementById('scheduleMinute');
        const secondInput = document.getElementById('scheduleSecond');

        if (hourInput) {
          hourInput.addEventListener('input', function () {
            if (this.value > 23) this.value = 23;
            if (this.value < 0) this.value = 0;
          });
        }

        if (minuteInput) {
          minuteInput.addEventListener('input', function () {
            if (this.value > 59) this.value = 59;
            if (this.value < 0) this.value = 0;
          });
        }

        if (secondInput) {
          secondInput.addEventListener('input', function () {
            if (this.value > 59) this.value = 59;
            if (this.value < 0) this.value = 0;
          });
        }
      });
    </script>
  </body>
</html>
