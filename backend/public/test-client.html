<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cliente de Test - Sistema de Tickets</title>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <style>
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f7f9;
        color: #333;
      }
      h1,
      h2,
      h3 {
        color: #2c3e50;
      }
      .section {
        border: 1px solid #ddd;
        margin: 20px 0;
        padding: 20px;
        border-radius: 8px;
        background-color: white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .tooltip {
        position: relative;
        display: inline-block;
        cursor: help;
      }
      .tooltip .tooltip-text {
        visibility: hidden;
        width: 280px;
        background-color: #2c3e50;
        color: #fff;
        text-align: center;
        border-radius: 6px;
        padding: 8px;
        position: absolute;
        z-index: 1;
        bottom: 125%;
        left: 50%;
        margin-left: -140px;
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 12px;
      }
      .tooltip:hover .tooltip-text {
        visibility: visible;
        opacity: 1;
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
      }
      .success {
        background-color: #d4edda;
        color: #155724;
      }
      .error {
        background-color: #f8d7da;
        color: #721c24;
      }
      .info {
        background-color: #d1ecf1;
        color: #0c5460;
      }
      button {
        padding: 10px 15px;
        margin: 5px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: 500;
      }
      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      }
      .btn-primary {
        background-color: #3498db;
        color: white;
      }
      .btn-success {
        background-color: #2ecc71;
        color: white;
      }
      .btn-warning {
        background-color: #f39c12;
        color: white;
      }
      .btn-danger {
        background-color: #e74c3c;
        color: white;
      }
      input,
      select {
        padding: 10px;
        margin: 5px;
        border: 1px solid #ddd;
        border-radius: 4px;
        transition: border 0.3s;
      }
      input:focus {
        border-color: #3498db;
        outline: none;
      }

      /* Log flotante */
      .log-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 50px;
        height: 50px;
        background-color: #3498db;
        border-radius: 50%;
        color: white;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        transition: all 0.3s;
      }
      .log-container.expanded {
        width: 500px;
        height: 400px;
        border-radius: 8px;
        background-color: white;
        overflow: hidden;
      }
      .log-header {
        display: none;
        background-color: #3498db;
        color: white;
        padding: 10px;
        justify-content: space-between;
        align-items: center;
      }
      .log-container.expanded .log-header {
        display: flex;
      }
      #log {
        display: none;
        height: 340px;
        overflow-y: scroll;
        padding: 10px;
        font-family: monospace;
        font-size: 12px;
        background-color: #f8f9fa;
      }
      .log-container.expanded #log {
        display: block;
      }
      .test-group {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        gap: 5px;
        flex-wrap: wrap;
      }
      .test-group h3 {
        margin: 0;
        min-width: 200px;
      }

      /* Grid layout for sections */
      .section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
      }
      .form-group {
        display: flex;
        align-items: center;
        gap: 5px;
        flex-wrap: wrap;
      }
      .close-button {
        cursor: pointer;
        background: none;
        border: none;
        color: white;
        font-size: 18px;
      }

      /* Estilos para tablas */
      table {
        font-size: 14px;
      }

      table th {
        font-weight: 600;
        text-transform: uppercase;
        font-size: 12px;
        letter-spacing: 0.5px;
      }

      table td {
        padding: 12px;
        border-bottom: 1px solid #eee;
        vertical-align: middle;
      }

      table tr:hover {
        background-color: #f8f9fa;
      }

      .status-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
      }

      .status-active {
        background: #d4edda;
        color: #155724;
      }

      .status-inactive {
        background: #f8d7da;
        color: #721c24;
      }

      .btn-table {
        padding: 4px 8px;
        font-size: 11px;
        margin: 0 2px;
        border-radius: 4px;
      }

      .config-item {
        margin-bottom: 15px;
      }

      .config-item label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #555;
        font-size: 13px;
      }

      .config-item input {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }

      /* Modal styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }

      .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 20px;
        border-radius: 8px;
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
      }

      .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #999;
      }

      .modal-close:hover {
        color: #333;
      }
    </style>
  </head>
  <body>
    <h1>Sistema de Registro de Tickets - Cliente de Prueba</h1>

    <div class="section">
      <h2>Conexión WebSocket</h2>
      <div class="tooltip">
        ℹ️
        <span class="tooltip-text">
          El WebSocket permite comunicación en tiempo real con el servidor.
          Conecta para recibir actualizaciones instantáneas sobre el estado del
          registro.
        </span>
      </div>
      <div class="form-group">
        <button id="connectBtn" class="btn-primary">Conectar</button>
        <button id="disconnectBtn" class="btn-danger">Desconectar</button>
        <div id="connectionStatus" class="status info">Desconectado</div>
      </div>
    </div>

    <div class="section">
      <h2>Tests de API REST</h2>
      <div class="tooltip">
        ℹ️
        <span class="tooltip-text">
          Estas opciones te permiten probar los diferentes endpoints de la API.
          Cada método tiene características distintas de velocidad y eficiencia.
        </span>
      </div>

      <div class="test-group">
        <h3>1. Registro Simple</h3>
        <div class="tooltip">
          ℹ️
          <span class="tooltip-text">
            Envía una única solicitud de registro con el DNI y código
            proporcionados. Velocidad: ⭐⭐ (básica)
          </span>
        </div>
        <div class="form-group">
          <input
            type="text"
            id="dniSimple"
            placeholder="DNI"
            value="73740592"
          />
          <input
            type="text"
            id="codeSimple"
            placeholder="Código"
            value="2021101380G"
          />
          <button onclick="testSimpleRegister()" class="btn-primary">
            Registrar Ticket
          </button>
        </div>
      </div>

      <div class="test-group">
        <h3>2. Registro Manual</h3>
        <div class="tooltip">
          ℹ️
          <span class="tooltip-text">
            Realiza múltiples intentos secuenciales para un usuario ya
            registrado en la base de datos. Velocidad: ⭐⭐⭐ (buena)
          </span>
        </div>
        <div class="form-group">
          <input
            type="number"
            id="userIdManual"
            placeholder="User ID"
            value="1"
          />
          <button onclick="testManualRegister()" class="btn-primary">
            Registro Manual
          </button>
        </div>
      </div>

      <div class="test-group">
        <h3>3. Registro Paralelo</h3>
        <div class="tooltip">
          ℹ️
          <span class="tooltip-text">
            Envía múltiples solicitudes simultáneamente para maximizar las
            probabilidades de éxito. Velocidad: ⭐⭐⭐⭐⭐ (ultra rápida)
          </span>
        </div>
        <div class="form-group">
          <input
            type="number"
            id="userIdParallel"
            placeholder="User ID"
            value="1"
          />
          <button onclick="testParallelRegister()" class="btn-success">
            Registro Paralelo
          </button>
        </div>
      </div>

      <div class="test-group">
        <h3>4. Registro Fast</h3>
        <div class="tooltip">
          ℹ️
          <span class="tooltip-text">
            Sistema de carrera que devuelve el primer resultado exitoso. Se
            detiene tan pronto como una solicitud tenga éxito. Velocidad:
            ⭐⭐⭐⭐⭐ (óptima)
          </span>
        </div>
        <div class="form-group">
          <input
            type="number"
            id="userIdFast"
            placeholder="User ID"
            value="1"
          />
          <button onclick="testFastRegister()" class="btn-warning">
            Registro Fast
          </button>
        </div>
      </div>

      <div class="test-group">
        <h3>5. Registro Masivo</h3>
        <div class="tooltip">
          ℹ️
          <span class="tooltip-text">
            Registra tickets para múltiples usuarios simultáneamente. Ideal para
            administradores que necesitan gestionar varios usuarios. Velocidad:
            ⭐⭐⭐⭐ (muy buena)
          </span>
        </div>
        <div class="form-group">
          <input
            type="text"
            id="userIdsBatch"
            placeholder="User IDs (separados por coma)"
            value="1,2,3"
          />
          <button onclick="testBatchRegister()" class="btn-danger">
            Registro Masivo
          </button>
        </div>
      </div>

      <div class="test-group">
        <h3>6. Estado del Sistema</h3>
        <div class="tooltip">
          ℹ️
          <span class="tooltip-text">
            Obtiene información sobre el estado actual del sistema, incluyendo
            el worker pool y la configuración activa.
          </span>
        </div>
        <div class="form-group">
          <button onclick="getSystemStatus()" class="btn-primary">
            Obtener Estado
          </button>
        </div>
      </div>

      <div class="test-group" style="grid-column: 1 / -1">
        <h3>7. Gestión de Programaciones</h3>
        <div class="tooltip">
          ℹ️
          <span class="tooltip-text">
            Sistema completo de gestión de programaciones con tabla interactiva,
            creación, edición y eliminación de programaciones automáticas.
          </span>
        </div>

        <!-- Botones de acción principales -->
        <div class="form-group" style="margin-bottom: 20px">
          <button onclick="showCreateScheduleModal()" class="btn-success">
            ➕ Nueva Programación
          </button>
          <button onclick="loadSchedulesTable()" class="btn-primary">
            🔄 Actualizar Tabla
          </button>
          <button onclick="loadUsers()" class="btn-primary">
            👥 Cargar Usuarios
          </button>
        </div>

        <!-- Tabla de programaciones -->
        <div style="overflow-x: auto; margin-top: 15px">
          <table
            id="schedulesTable"
            style="
              width: 100%;
              border-collapse: collapse;
              background: white;
              border-radius: 8px;
              overflow: hidden;
              box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            "
          >
            <thead
              style="
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
              "
            >
              <tr>
                <th style="padding: 12px; text-align: left">ID</th>
                <th style="padding: 12px; text-align: left">Usuario</th>
                <th style="padding: 12px; text-align: left">Fecha</th>
                <th style="padding: 12px; text-align: left">Hora</th>
                <th style="padding: 12px; text-align: left">Descripción</th>
                <th style="padding: 12px; text-align: left">Recurrente</th>
                <th style="padding: 12px; text-align: left">Estado</th>
                <th style="padding: 12px; text-align: center">Acciones</th>
              </tr>
            </thead>
            <tbody id="schedulesTableBody">
              <tr>
                <td
                  colspan="8"
                  style="padding: 20px; text-align: center; color: #666"
                >
                  Cargando programaciones...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="test-group" style="grid-column: 1 / -1">
        <h3>8. Configuración del Sistema</h3>
        <div class="tooltip">
          ℹ️
          <span class="tooltip-text">
            Configuración avanzada del sistema: worker pool, intervalos, número
            de intentos y URL de la API.
          </span>
        </div>

        <div class="form-group" style="margin-bottom: 20px">
          <button onclick="loadSystemConfig()" class="btn-primary">
            📊 Cargar Configuración
          </button>
          <button onclick="saveSystemConfig()" class="btn-success">
            💾 Guardar Cambios
          </button>
        </div>

        <!-- Tabla de configuración -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px">
          <div
            style="
              background: white;
              padding: 20px;
              border-radius: 8px;
              box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            "
          >
            <h4 style="margin-bottom: 15px; color: #2c3e50">⚙️ Worker Pool</h4>
            <div class="config-item">
              <label>Trabajos Actuales:</label>
              <input
                type="number"
                id="currentJobs"
                readonly
                style="background: #f5f5f5"
              />
            </div>
            <div class="config-item">
              <label>Máximo Concurrente:</label>
              <input type="number" id="maxConcurrent" min="1" max="50" />
            </div>
            <div class="config-item">
              <label>Slots Disponibles:</label>
              <input
                type="number"
                id="availableSlots"
                readonly
                style="background: #f5f5f5"
              />
            </div>
          </div>

          <div
            style="
              background: white;
              padding: 20px;
              border-radius: 8px;
              box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            "
          >
            <h4 style="margin-bottom: 15px; color: #2c3e50">
              🔧 Configuración
            </h4>
            <div class="config-item">
              <label>Intentos por Defecto:</label>
              <input type="number" id="defaultRequests" min="1" max="20" />
            </div>
            <div class="config-item">
              <label>Intervalo (ms):</label>
              <input type="number" id="defaultInterval" min="10" max="5000" />
            </div>
            <div class="config-item">
              <label>URL de la API:</label>
              <input type="url" id="apiUrl" style="width: 100%" />
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="section">
      <h2>Tests WebSocket</h2>
      <div class="tooltip">
        ℹ️
        <span class="tooltip-text">
          Los tests WebSocket permiten una comunicación bidireccional en tiempo
          real. Recibirás actualizaciones instantáneas sobre el proceso de
          registro.
        </span>
      </div>

      <div class="test-group">
        <h3>Registro via WebSocket</h3>
        <div class="tooltip">
          ℹ️
          <span class="tooltip-text">
            Envía una solicitud de registro a través de WebSocket y recibe
            actualizaciones en tiempo real sobre su estado y resultado.
          </span>
        </div>
        <div class="form-group">
          <input type="text" id="dniWS" placeholder="DNI" value="73740592" />
          <input
            type="text"
            id="codeWS"
            placeholder="Código"
            value="2021101380G"
          />
          <button onclick="testWebSocketRegister()" class="btn-success">
            Registrar via WS
          </button>
        </div>
      </div>

      <div class="test-group">
        <h3>Registro Paralelo WS</h3>
        <div class="tooltip">
          ℹ️
          <span class="tooltip-text">
            Realiza múltiples intentos paralelos a través de WebSocket. Podrás
            ver el progreso en tiempo real de cada intento.
          </span>
        </div>
        <div class="form-group">
          <input type="number" id="userIdWS" placeholder="User ID" value="1" />
          <input
            type="number"
            id="attemptsWS"
            placeholder="Intentos"
            value="8"
          />
          <button onclick="testWebSocketParallel()" class="btn-warning">
            Paralelo via WS
          </button>
        </div>
      </div>
    </div>

    <!-- Log flotante -->
    <div class="log-container" id="logContainer">
      <div id="logBubble">📋</div>
      <div class="log-header">
        <h3>Log de Eventos</h3>
        <button class="close-button" id="closeLog">✖</button>
      </div>
      <div id="log"></div>
    </div>

    <!-- Modal para crear/editar programación -->
    <div id="scheduleModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="modalTitle">Nueva Programación</h3>
          <button class="modal-close" onclick="closeScheduleModal()">×</button>
        </div>

        <form id="scheduleForm">
          <input type="hidden" id="editScheduleId" />

          <div class="config-item">
            <label for="modalUserSelect">Usuario:</label>
            <select id="modalUserSelect" required>
              <option value="">Seleccionar usuario...</option>
            </select>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px">
            <div class="config-item">
              <label for="modalScheduleDate">Fecha:</label>
              <input type="date" id="modalScheduleDate" required />
            </div>

            <div class="config-item">
              <label for="modalScheduleTime">Hora (HH:MM:SS):</label>
              <input
                type="text"
                id="modalScheduleTime"
                value="10:00:00"
                pattern="^([0-1]?[0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]$"
                title="Formato: HH:MM:SS"
                required
              />
            </div>
          </div>

          <div class="config-item">
            <label for="modalScheduleDescription">Descripción:</label>
            <input
              type="text"
              id="modalScheduleDescription"
              placeholder="Descripción opcional"
            />
          </div>

          <div class="config-item">
            <label>
              <input type="checkbox" id="modalIsRecurring" />
              Programación recurrente
            </label>
          </div>

          <div id="modalRecurringDays" style="display: none">
            <label>Días de la semana:</label>
            <div
              style="
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
                margin-top: 10px;
              "
            >
              <label
                ><input type="checkbox" id="modalMonday" value="monday" />
                Lunes</label
              >
              <label
                ><input type="checkbox" id="modalTuesday" value="tuesday" />
                Martes</label
              >
              <label
                ><input type="checkbox" id="modalWednesday" value="wednesday" />
                Miércoles</label
              >
              <label
                ><input type="checkbox" id="modalThursday" value="thursday" />
                Jueves</label
              >
              <label
                ><input type="checkbox" id="modalFriday" value="friday" />
                Viernes</label
              >
              <label
                ><input type="checkbox" id="modalSaturday" value="saturday" />
                Sábado</label
              >
              <label
                ><input type="checkbox" id="modalSunday" value="sunday" />
                Domingo</label
              >
            </div>
          </div>

          <div
            style="
              display: flex;
              gap: 10px;
              margin-top: 20px;
              justify-content: flex-end;
            "
          >
            <button
              type="button"
              onclick="closeScheduleModal()"
              class="btn-danger"
            >
              Cancelar
            </button>
            <button type="submit" class="btn-success">
              Guardar Programación
            </button>
          </div>
        </form>
      </div>
    </div>

    <script>
      let socket = null;
      const API_BASE = 'http://localhost:3000';

      // Manejar el log flotante
      const logContainer = document.getElementById('logContainer');
      const closeLogBtn = document.getElementById('closeLog');

      logContainer.addEventListener('click', function (e) {
        if (e.target !== closeLogBtn) {
          this.classList.toggle('expanded');
        }
      });

      closeLogBtn.addEventListener('click', function (e) {
        e.stopPropagation();
        logContainer.classList.remove('expanded');
      });

      function log(message, type = 'info') {
        const logDiv = document.getElementById('log');
        const timestamp = new Date().toLocaleTimeString();
        const entry = document.createElement('div');
        entry.className = type;
        entry.innerHTML = `[${timestamp}] ${message}`;
        logDiv.appendChild(entry);
        logDiv.scrollTop = logDiv.scrollHeight;

        // Auto-expand log on new entries
        if (!logContainer.classList.contains('expanded')) {
          logContainer.classList.add('expanded');
          setTimeout(() => {
            if (!document.hasFocus()) {
              logContainer.classList.remove('expanded');
            }
          }, 3000);
        }
      }

      function clearLog() {
        document.getElementById('log').innerHTML = '';
      }

      // Helper function to get human-readable message for response codes
      function getCodeMessage(code) {
        const codeMessages = {
          201: '✅ Ticket obtenido exitosamente',
          300: '⚠️ Múltiples opciones disponibles',
          400: '❌ Solicitud incorrecta',
          401: '🔒 No autorizado',
          403: '🚫 Acceso prohibido',
          404: '🔍 No encontrado',
          409: '⚡ Conflicto - posiblemente ya registrado',
          429: '🚦 Demasiadas solicitudes',
          500: '💥 Error interno del servidor',
          502: '🌐 Error de gateway',
          503: '⏳ Servicio no disponible',
          504: '⏰ Timeout del gateway',
        };

        return codeMessages[code] || `❓ Código desconocido: ${code}`;
      }

      // WebSocket Connection
      document.getElementById('connectBtn').onclick = function () {
        if (socket) return;

        socket = io('http://localhost:3000');

        socket.on('connect', () => {
          log('✅ Conectado al WebSocket', 'success');
          document.getElementById('connectionStatus').innerHTML = 'Conectado';
          document.getElementById('connectionStatus').className =
            'status success';
        });

        socket.on('disconnect', () => {
          log('❌ Desconectado del WebSocket', 'error');
          document.getElementById('connectionStatus').innerHTML =
            'Desconectado';
          document.getElementById('connectionStatus').className =
            'status error';
        });

        socket.on('registerStatus', (data) => {
          log(`📊 Estado: ${data.status} - ${data.message}`, 'info');
        });

        socket.on('registerResult', (data) => {
          log(
            `📋 Resultado: ${JSON.stringify(data)}`,
            data.code === 201 ? 'success' : 'error',
          );
        });

        socket.on('registerError', (data) => {
          log(`❌ Error: ${data.message}`, 'error');
        });

        socket.on('parallelResults', (data) => {
          log(`🏃‍♂️ Paralelo: ${data.successful}/${data.total} exitosos`, 'info');
        });

        socket.on('globalStatus', (data) => {
          log(`🌐 ${data.message}`, 'info');

          // Show detailed results if available
          if (data.data && data.data.results) {
            log(`📊 Detalles de resultados:`, 'info');
            data.data.results.forEach((result, index) => {
              const status = result.code === 201 ? 'success' : 'error';
              log(
                `   ${index + 1}. Código: ${result.code} - ${getCodeMessage(result.code)}`,
                status,
              );
            });

            if (data.data.summary) {
              log(
                `📋 Resumen: ${data.data.successfulAttempts}/${data.data.totalAttempts} exitosos`,
                'info',
              );
            }
          }
        });

        // Nuevos listeners para eventos de programación
        socket.on('scheduleStatus', (data) => {
          log(
            `📅 Programación: ${data.message}`,
            data.success ? 'success' : 'info',
          );
        });
      };

      document.getElementById('disconnectBtn').onclick = function () {
        if (socket) {
          socket.disconnect();
          socket = null;
        }
      };

      // API REST Tests
      async function testSimpleRegister() {
        const dni = document.getElementById('dniSimple').value;
        const code = document.getElementById('codeSimple').value;

        log(`📤 Enviando registro simple para DNI: ${dni}`);

        try {
          const response = await fetch(`${API_BASE}/tickets/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ dni, code }),
          });

          const result = await response.json();
          log(
            `📥 Respuesta: ${JSON.stringify(result)}`,
            result.code === 201 ? 'success' : 'error',
          );
        } catch (error) {
          log(`❌ Error: ${error.message}`, 'error');
        }
      }

      // Modificar la función testManualRegister para mostrar más detalles
      async function testManualRegister() {
        const userId = document.getElementById('userIdManual').value;
        log(`📤 Enviando registro manual para usuario ${userId}`);

        try {
          const response = await fetch(`${API_BASE}/tickets/manual/${userId}`, {
            method: 'POST',
          });

          const result = await response.json();
          const successful = result.filter((r) => r.code === 201).length;

          // Mostrar un resumen
          log(
            `📥 Manual: ${successful}/${result.length} exitosos`,
            successful > 0 ? 'success' : 'error',
          );

          // Mostrar códigos individuales
          result.forEach((res, index) => {
            const status = res.code === 201 ? 'success' : 'error';
            log(
              `   ${index + 1}. Código: ${res.code} - ${getCodeMessage(res.code)}`,
              status,
            );
          });
        } catch (error) {
          log(`❌ Error: ${error.message}`, 'error');
        }
      }

      // Modificar la función testParallelRegister para mostrar más detalles
      async function testParallelRegister() {
        const userId = document.getElementById('userIdParallel').value;
        log(`🚀 Enviando registro paralelo para usuario ${userId}`);

        try {
          const response = await fetch(
            `${API_BASE}/tickets/parallel/${userId}`,
            {
              method: 'POST',
            },
          );

          const result = await response.json();
          const successful = result.filter((r) => r.code === 201).length;

          // Mostrar un resumen
          log(
            `📥 Paralelo: ${successful}/${result.length} exitosos`,
            successful > 0 ? 'success' : 'error',
          );

          // Mostrar códigos individuales
          result.forEach((res, index) => {
            const status = res.code === 201 ? 'success' : 'error';
            log(
              `   ${index + 1}. Código: ${res.code} - ${getCodeMessage(res.code)}`,
              status,
            );
          });
        } catch (error) {
          log(`❌ Error: ${error.message}`, 'error');
        }
      }

      async function testFastRegister() {
        const userId = document.getElementById('userIdFast').value;
        log(`⚡ Enviando registro fast para usuario ${userId}`);

        try {
          const response = await fetch(`${API_BASE}/tickets/fast/${userId}`, {
            method: 'POST',
          });

          const result = await response.json();
          log(
            `📥 Fast: ${JSON.stringify(result)}`,
            result.code === 201 ? 'success' : 'error',
          );
        } catch (error) {
          log(`❌ Error: ${error.message}`, 'error');
        }
      }

      // Modificar la función testBatchRegister para mostrar más detalles
      async function testBatchRegister() {
        const userIds = document
          .getElementById('userIdsBatch')
          .value.split(',')
          .map((id) => parseInt(id.trim()));
        log(`📦 Enviando registro masivo para usuarios: ${userIds.join(', ')}`);

        try {
          const response = await fetch(`${API_BASE}/tickets/batch-register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userIds }),
          });

          const result = await response.json();
          const successful = Object.values(result).filter(
            (r) => r.code === 201,
          ).length;

          // Mostrar un resumen
          log(
            `📥 Masivo: ${successful}/${userIds.length} exitosos`,
            successful > 0 ? 'success' : 'error',
          );

          // Mostrar resultados por usuario
          Object.entries(result).forEach(([userId, res]) => {
            const status = res.code === 201 ? 'success' : 'error';
            log(
              `   Usuario ${userId}: Código ${res.code} - ${getCodeMessage(res.code)}`,
              status,
            );
          });
        } catch (error) {
          log(`❌ Error: ${error.message}`, 'error');
        }
      }

      async function getSystemStatus() {
        log(`📊 Obteniendo estado del sistema`);

        try {
          const response = await fetch(`${API_BASE}/tickets/status`);
          const result = await response.json();
          log(`📥 Estado: ${JSON.stringify(result, null, 2)}`, 'info');
        } catch (error) {
          log(`❌ Error: ${error.message}`, 'error');
        }
      }

      // WebSocket Tests
      function testWebSocketRegister() {
        if (!socket) {
          log(
            '❌ No hay conexión WebSocket. Por favor, conecta primero.',
            'error',
          );
          return;
        }

        const dni = document.getElementById('dniWS').value;
        const code = document.getElementById('codeWS').value;

        log(`🔌 Enviando registro via WebSocket para DNI: ${dni}`);
        socket.emit('registerTicket', { dni, code });
      }

      function testWebSocketParallel() {
        if (!socket) {
          log(
            '❌ No hay conexión WebSocket. Por favor, conecta primero.',
            'error',
          );
          return;
        }

        const userId = parseInt(document.getElementById('userIdWS').value);
        const attempts = parseInt(document.getElementById('attemptsWS').value);

        log(
          `🔌 Enviando registro paralelo via WebSocket para usuario: ${userId} (${attempts} intentos)`,
        );
        socket.emit('parallelRegister', { userId, attempts });
      }

      // Auto-connect on load
      window.onload = function () {
        log('🚀 Cliente de test iniciado');

        // Load initial data
        loadUsers();
        loadSchedulesTable();
        loadSystemConfig();

        // Auto-connect WebSocket after 1 second
        setTimeout(() => {
          document.getElementById('connectBtn').click();
        }, 1000);

        // Close modal when clicking outside
        window.onclick = function (event) {
          const modal = document.getElementById('scheduleModal');
          if (event.target === modal) {
            closeScheduleModal();
          }
        };
      };

      // Variables globales
      let allUsers = [];
      let allSchedules = [];
      let systemConfig = {};

      // Gestión de usuarios
      async function loadUsers() {
        try {
          const response = await fetch(`${API_BASE}/users`);
          allUsers = await response.json();

          const select = document.getElementById('userSelect');
          if (select) {
            select.innerHTML =
              '<option value="">Seleccionar usuario...</option>';

            allUsers.forEach((user) => {
              const option = document.createElement('option');
              option.value = user.id;
              option.textContent = `${user.name} (${user.dni})`;
              select.appendChild(option);
            });
          }

          log(`👥 Cargados ${allUsers.length} usuarios`, 'success');
        } catch (error) {
          log(`❌ Error cargando usuarios: ${error.message}`, 'error');
        }
      }

      // Funciones de gestión de programaciones
      async function loadSchedulesTable() {
        log(`📋 Cargando tabla de programaciones`);

        try {
          const response = await fetch(`${API_BASE}/schedules`);
          allSchedules = await response.json();

          renderSchedulesTable();
          log(`📋 Programaciones cargadas: ${allSchedules.length}`, 'success');
        } catch (error) {
          log(`❌ Error cargando programaciones: ${error.message}`, 'error');
        }
      }

      function renderSchedulesTable() {
        const tbody = document.getElementById('schedulesTableBody');

        if (allSchedules.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="8" style="padding: 20px; text-align: center; color: #666;">
                No hay programaciones disponibles
              </td>
            </tr>
          `;
          return;
        }

        tbody.innerHTML = allSchedules
          .map((schedule) => {
            const date = new Date(schedule.scheduledDate).toLocaleDateString();
            const recurringDays = schedule.recurringDays
              ? JSON.parse(schedule.recurringDays).join(', ')
              : 'No';

            return `
            <tr>
              <td><strong>#${schedule.id}</strong></td>
              <td>
                <div style="font-weight: 600;">${schedule.user.name}</div>
                <div style="font-size: 11px; color: #666;">${schedule.user.dni}</div>
              </td>
              <td>${date}</td>
              <td><code>${schedule.scheduledTime}</code></td>
              <td>${schedule.description || '<em>Sin descripción</em>'}</td>
              <td>
                ${
                  schedule.isRecurring
                    ? `<span style="color: #28a745;">✓ ${recurringDays}</span>`
                    : '<span style="color: #6c757d;">No</span>'
                }
              </td>
              <td>
                <span class="status-badge ${schedule.isActive ? 'status-active' : 'status-inactive'}">
                  ${schedule.isActive ? 'Activo' : 'Inactivo'}
                </span>
              </td>
              <td style="text-align: center;">
                <button onclick="editSchedule(${schedule.id})" class="btn-table btn-primary" title="Editar">
                  ✏️
                </button>
                <button onclick="toggleScheduleStatus(${schedule.id})" class="btn-table ${schedule.isActive ? 'btn-warning' : 'btn-success'}" title="${schedule.isActive ? 'Desactivar' : 'Activar'}">
                  ${schedule.isActive ? '⏸️' : '▶️'}
                </button>
                <button onclick="deleteSchedule(${schedule.id})" class="btn-table btn-danger" title="Eliminar">
                  🗑️
                </button>
              </td>
            </tr>
          `;
          })
          .join('');
      }

      // Modal functions
      function showCreateScheduleModal() {
        document.getElementById('modalTitle').textContent =
          'Nueva Programación';
        document.getElementById('editScheduleId').value = '';
        document.getElementById('scheduleForm').reset();
        document.getElementById('modalScheduleTime').value = '10:00:00';

        // Set default date to tomorrow
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        document.getElementById('modalScheduleDate').value = tomorrow
          .toISOString()
          .split('T')[0];

        // Load users in modal
        loadUsersInModal();

        document.getElementById('scheduleModal').style.display = 'block';
      }

      function closeScheduleModal() {
        document.getElementById('scheduleModal').style.display = 'none';
      }

      async function loadUsersInModal() {
        const select = document.getElementById('modalUserSelect');
        select.innerHTML = '<option value="">Cargando usuarios...</option>';

        try {
          if (allUsers.length === 0) {
            const response = await fetch(`${API_BASE}/users`);
            allUsers = await response.json();
          }

          select.innerHTML = '<option value="">Seleccionar usuario...</option>';
          allUsers.forEach((user) => {
            const option = document.createElement('option');
            option.value = user.id;
            option.textContent = `${user.name} (${user.dni})`;
            select.appendChild(option);
          });
        } catch (error) {
          select.innerHTML =
            '<option value="">Error cargando usuarios</option>';
          log(`❌ Error cargando usuarios: ${error.message}`, 'error');
        }
      }

      // Handle recurring checkbox
      document.getElementById('modalIsRecurring').onchange = function () {
        const recurringDiv = document.getElementById('modalRecurringDays');
        recurringDiv.style.display = this.checked ? 'block' : 'none';
      };

      // Handle form submission
      document.getElementById('scheduleForm').onsubmit = async function (e) {
        e.preventDefault();

        const scheduleId = document.getElementById('editScheduleId').value;
        const isEdit = !!scheduleId;

        const formData = {
          userId: parseInt(document.getElementById('modalUserSelect').value),
          scheduledDate: document.getElementById('modalScheduleDate').value,
          scheduledTime: document.getElementById('modalScheduleTime').value,
          description:
            document.getElementById('modalScheduleDescription').value ||
            'Registro automático',
          isRecurring: document.getElementById('modalIsRecurring').checked,
        };

        if (formData.isRecurring) {
          const days = [];
          [
            'modalMonday',
            'modalTuesday',
            'modalWednesday',
            'modalThursday',
            'modalFriday',
            'modalSaturday',
            'modalSunday',
          ].forEach((id) => {
            const checkbox = document.getElementById(id);
            if (checkbox && checkbox.checked) {
              days.push(checkbox.value);
            }
          });
          formData.recurringDays = days;
        }

        try {
          const url = isEdit
            ? `${API_BASE}/schedules/${scheduleId}`
            : `${API_BASE}/schedules`;
          const method = isEdit ? 'PATCH' : 'POST';

          const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData),
          });

          const result = await response.json();

          if (response.ok) {
            log(
              `✅ Programación ${isEdit ? 'actualizada' : 'creada'} exitosamente`,
              'success',
            );
            closeScheduleModal();
            loadSchedulesTable();
          } else {
            log(
              `❌ Error: ${result.message || JSON.stringify(result)}`,
              'error',
            );
          }
        } catch (error) {
          log(`❌ Error: ${error.message}`, 'error');
        }
      };

      async function editSchedule(id) {
        const schedule = allSchedules.find((s) => s.id === id);
        if (!schedule) return;

        document.getElementById('modalTitle').textContent =
          'Editar Programación';
        document.getElementById('editScheduleId').value = id;

        // Load users first
        await loadUsersInModal();

        // Fill form
        document.getElementById('modalUserSelect').value = schedule.userId;
        document.getElementById('modalScheduleDate').value =
          schedule.scheduledDate.split('T')[0];
        document.getElementById('modalScheduleTime').value =
          schedule.scheduledTime;
        document.getElementById('modalScheduleDescription').value =
          schedule.description || '';
        document.getElementById('modalIsRecurring').checked =
          schedule.isRecurring;

        // Handle recurring days
        const recurringDiv = document.getElementById('modalRecurringDays');
        recurringDiv.style.display = schedule.isRecurring ? 'block' : 'none';

        if (schedule.isRecurring && schedule.recurringDays) {
          const days = JSON.parse(schedule.recurringDays);
          [
            'modalMonday',
            'modalTuesday',
            'modalWednesday',
            'modalThursday',
            'modalFriday',
            'modalSaturday',
            'modalSunday',
          ].forEach((id) => {
            const checkbox = document.getElementById(id);
            if (checkbox) {
              checkbox.checked = days.includes(checkbox.value);
            }
          });
        }

        document.getElementById('scheduleModal').style.display = 'block';
      }

      async function toggleScheduleStatus(id) {
        try {
          const response = await fetch(`${API_BASE}/schedules/${id}/toggle`, {
            method: 'PATCH',
          });

          if (response.ok) {
            log(`✅ Estado de programación ${id} cambiado`, 'success');
            loadSchedulesTable();
          } else {
            log(`❌ Error cambiando estado de programación ${id}`, 'error');
          }
        } catch (error) {
          log(`❌ Error: ${error.message}`, 'error');
        }
      }

      async function deleteSchedule(id) {
        if (!confirm('¿Estás seguro de eliminar esta programación?')) return;

        try {
          const response = await fetch(`${API_BASE}/schedules/${id}`, {
            method: 'DELETE',
          });

          if (response.ok) {
            log(`✅ Programación ${id} eliminada`, 'success');
            loadSchedulesTable();
          } else {
            log(`❌ Error eliminando programación ${id}`, 'error');
          }
        } catch (error) {
          log(`❌ Error: ${error.message}`, 'error');
        }
      }

      // System configuration functions
      async function loadSystemConfig() {
        log(`📊 Cargando configuración del sistema`);

        try {
          const response = await fetch(`${API_BASE}/tickets/status`);
          systemConfig = await response.json();

          // Fill configuration form
          document.getElementById('currentJobs').value =
            systemConfig.workerPool.currentJobs;
          document.getElementById('maxConcurrent').value =
            systemConfig.workerPool.maxConcurrent;
          document.getElementById('availableSlots').value =
            systemConfig.workerPool.availableSlots;
          document.getElementById('defaultRequests').value =
            systemConfig.configuration.defaultRequests;
          document.getElementById('defaultInterval').value =
            systemConfig.configuration.defaultInterval;
          document.getElementById('apiUrl').value = systemConfig.apiUrl;

          log(`✅ Configuración cargada`, 'success');
        } catch (error) {
          log(`❌ Error cargando configuración: ${error.message}`, 'error');
        }
      }

      async function saveSystemConfig() {
        const newConfig = {
          maxConcurrent: parseInt(
            document.getElementById('maxConcurrent').value,
          ),
          defaultRequests: document.getElementById('defaultRequests').value,
          defaultInterval: document.getElementById('defaultInterval').value,
          apiUrl: document.getElementById('apiUrl').value,
        };

        log(`💾 Guardando configuración...`);
        log(
          `📋 Nueva configuración: ${JSON.stringify(newConfig, null, 2)}`,
          'info',
        );

        // Note: This would need backend endpoints to actually save the configuration
        // For now, just show what would be saved
        log(
          `⚠️ Función de guardado pendiente de implementación en backend`,
          'info',
        );
      }
    </script>
  </body>
</html>
